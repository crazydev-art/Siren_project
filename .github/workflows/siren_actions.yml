name: Check and Deploy Python Files

on:
  push:
    branches:
      - dev  # Trigger on pushes to the 'dev' branch

jobs:
  check-python-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        if: env.found_py == 'true'
        run: |
          pip install --upgrade pip
          pip install pytest python-dotenv
      
      - name: Find Python Files
        id: find_py_files
        run: |
          PY_FILES=$(find . -type f -name "*.py")
          if [ -z "$PY_FILES" ]; then
            echo "No Python files found."
            echo "found_py=false" >> $GITHUB_ENV
          else
            echo "Found Python files:"
            echo "$PY_FILES"
            echo "found_py=true" >> $GITHUB_ENV
          fi

      - name: Create Test Files
        if: env.found_py == 'true'
        run: |
          for file in $(find . -type f -name "*.py"); do
            cp "$file" "$(dirname $file)/test_$(basename $file)"
          done

      - name: Run Pytest
        if: env.found_py == 'true'
        run: |
          pip install pytest
          pytest --maxfail=1 --disable-warnings

      - name: Deploy to Prod and Main
        if: env.found_py == 'true'
        run: |
          git config --global user.email "lionel.matter@outlook.fr"

          # Copy files to main and prod branches
          git checkout main
          git pull origin main
          git checkout dev -- .
          git commit -am "Deploying Python files from dev to main"
          git push origin main

          git checkout prod
          git pull origin prod
          git checkout dev -- .
          git commit -am "Deploying Python files from dev to prod"
          git push origin prod

      - name: Log No Python Files
        if: env.found_py == 'false'
        run: echo "No Python files found in this push."